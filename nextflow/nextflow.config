/*
========================================================================================
    StrandWeaver v0.1.0 - Nextflow Configuration
========================================================================================
*/

// Global default params
params {
    // Input/output options
    hifi                      = null
    ont                       = null
    ont_ul                    = null
    illumina_r1               = null
    illumina_r2               = null
    hic_r1                    = null
    hic_r2                    = null
    outdir                    = './results'
    
    // Assembly options
    enable_ai                 = true
    detect_svs                = true
    preserve_heterozygosity   = true
    min_identity              = 0.995
    huge                      = false  // Enable parallel k-mer extraction for huge genomes
    
    // K-mer options (auto-detected by K-Weaver if null)
    kmer_size                 = null
    
    // Parallelization batch sizes
    correction_batch_size     = 100000   // Reads per correction job
    edge_batch_size           = 10000    // Edges per scoring job
    ul_batch_size             = 100      // UL reads per mapping job
    hic_batch_size            = 500000   // Read pairs per Hi-C alignment job
    sv_batch_size             = 1000     // Nodes per SV detection job
    kmer_batch_size           = 1000000  // Reads per k-mer extraction job (--huge mode)
    
    // Max parallel jobs (prevent cluster overload)
    max_correction_jobs       = 20
    max_edge_jobs             = 8
    max_ul_jobs               = 10
    max_hic_jobs              = 15
    max_sv_jobs               = 10
    max_kmer_jobs             = 12       // For --huge mode
    
    // Resource limits
    max_cpus                  = 64
    max_memory                = '512.GB'
    max_time                  = '240.h'
    
    // Help
    help                      = false
}

// Load base config
includeConfig 'conf/base.config'

// Profiles
profiles {
    docker {
        docker.enabled         = true
        docker.userEmulation   = true
        includeConfig 'conf/docker.config'
    }
    
    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        includeConfig 'conf/singularity.config'
    }
    
    slurm {
        process.executor       = 'slurm'
        includeConfig 'conf/slurm.config'
    }
    
    test {
        includeConfig 'conf/test.config'
    }
    
    local {
        process.executor       = 'local'
    }
}

// Manifest
manifest {
    name            = 'StrandWeaver'
    author          = 'Patrick Grady'
    homePage        = 'https://github.com/pgrady1322/strandweaver'
    description     = 'AI-Powered Multi-Technology Genome Assembler with GPU Acceleration'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=22.10.0'
    version         = '0.1.0'
}

// Function to ensure that resource requirements don't go beyond a maximum limit
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max memory '${params.max_memory}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max time '${params.max_time}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.max_cpus as int )
        } catch (all) {
            println "   ### ERROR ###   Max cpus '${params.max_cpus}' is not valid! Using default value: $obj"
            return obj
        }
    }
}
